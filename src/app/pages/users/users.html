<div class="p-6">
  <div class="flex justify-between items-center border-b border-gray-200 pb-4 my-6">
    <h1 class="text-3xl font-bold" style="color: #0d5a4b">Users</h1>
    <button
      (click)="router.navigate(['/users/add'])"
      class="px-4 py-2 text-white rounded-md transition-colors flex items-center gap-2"
      style="background-color: #e2b43a; color: #0a3022"
      onmouseover="this.style.backgroundColor='#d4a530'"
      onmouseout="this.style.backgroundColor='#E2B43A'"
    >
      <lucide-angular [img]="Plus" class="w-5 h-5" />
      Add New User
    </button>
  </div>

  <!-- Search and Filter Section -->
  <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Search Input -->
      <div class="lg:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
        <div class="relative">
          <lucide-angular
            [img]="Search"
            class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
          />
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            placeholder="Search by name, email, phone, or role..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-transparent"
            style="--tw-ring-color: #e2b43a"
            onfocus="this.style.borderColor='#E2B43A'; this.style.boxShadow='0 0 0 2px rgba(226, 180, 58, 0.2)'"
            onblur="this.style.borderColor=''; this.style.boxShadow=''"
          />
        </div>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        <select
          [(ngModel)]="statusFilter"
          (ngModelChange)="onFilterChange()"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-transparent bg-white"
          style="--tw-ring-color: #e2b43a"
          onfocus="this.style.borderColor='#E2B43A'; this.style.boxShadow='0 0 0 2px rgba(226, 180, 58, 0.2)'"
          onblur="this.style.borderColor=''; this.style.boxShadow=''"
        >
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <!-- Email Confirmed Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Email Status</label>
        <select
          [(ngModel)]="emailConfirmedFilter"
          (ngModelChange)="onFilterChange()"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-transparent bg-white"
          style="--tw-ring-color: #e2b43a"
          onfocus="this.style.borderColor='#E2B43A'; this.style.boxShadow='0 0 0 2px rgba(226, 180, 58, 0.2)'"
          onblur="this.style.borderColor=''; this.style.boxShadow=''"
        >
          <option value="all">All</option>
          <option value="confirmed">Confirmed</option>
          <option value="notConfirmed">Not Confirmed</option>
        </select>
      </div>
    </div>

    <!-- Role Filter and Clear Button -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
        <select
          [(ngModel)]="roleFilter"
          (ngModelChange)="onFilterChange()"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-transparent bg-white"
          style="--tw-ring-color: #e2b43a"
          onfocus="this.style.borderColor='#E2B43A'; this.style.boxShadow='0 0 0 2px rgba(226, 180, 58, 0.2)'"
          onblur="this.style.borderColor=''; this.style.boxShadow=''"
        >
          <option value="all">All Roles</option>
          @for (role of getUniqueRoles(); track role) {
          <option [value]="role">{{ role }}</option>
          }
        </select>
      </div>

      <div class="flex items-end">
        <button
          (click)="clearFilters()"
          class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center justify-center gap-2"
        >
          <lucide-angular [img]="X" class="w-4 h-4" />
          Clear Filters
        </button>
      </div>
    </div>

    <!-- Results Count -->
    @if (searchTerm || statusFilter !== 'all' || emailConfirmedFilter !== 'all' || roleFilter !==
    'all') {
    <div class="mt-4 text-sm text-gray-600">
      Showing {{ filteredUsers.length }} of {{ users.length }} users
    </div>
    }
  </div>

  <p-table
    [value]="filteredUsers"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5, 10, 20, 50]"
    [tableStyle]="{ 'min-width': '50rem' }"
    styleClass="p-datatable-striped"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>#</th>
        <th>Image</th>
        <th>User Name</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Roles</th>
        <th>Status</th>
        <th>Email Confirmed</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-user let-i="rowIndex">
      <tr>
        <td>{{ i + 1 }}</td>
        <td>
          <img
            [src]="getFullImageUrl(user.imageUrl, 'user')"
            [alt]="user.userName"
            class="w-10 h-10 rounded-full object-cover"
            onerror="this.src='blog/3.jpg'"
          />
        </td>
        <td>{{ user.userName }}</td>
        <td>{{ getFullName(user) }}</td>
        <td>{{ user.email }}</td>
        <td>{{ getDisplayPhone(user) }}</td>
        <td>
          @if (user.roles && user.roles.length > 0) {
          <div class="flex flex-wrap gap-1">
            @for (role of user.roles; track role) {
            <span
              class="px-2 py-1 rounded-full text-xs font-semibold"
              style="background-color: #e2b43a; color: #0a3022"
            >
              {{ role }}
            </span>
            }
          </div>
          } @else {
          <span class="text-gray-400">-</span>
          }
        </td>
        <td>
          <span
            class="px-2 py-1 rounded-full text-xs font-semibold"
            [style.background-color]="user.isActive ? '#d1fae5' : '#fee2e2'"
            [style.color]="user.isActive ? '#065f46' : '#991b1b'"
          >
            {{ user.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
        <td>
          <span
            class="px-2 py-1 rounded-full text-xs font-semibold"
            [style.background-color]="user.emailConfirmed ? '#d1fae5' : '#fee2e2'"
            [style.color]="user.emailConfirmed ? '#065f46' : '#991b1b'"
          >
            {{ user.emailConfirmed ? 'Confirmed' : 'Not Confirmed' }}
          </span>
        </td>
        <td>
          <div class="flex gap-2">
            <button
              (click)="viewUserDetails(user)"
              class="p-2 rounded-md transition-colors"
              style="background-color: #e2b43a; color: #0a3022"
              onmouseover="this.style.backgroundColor='#d4a530'"
              onmouseout="this.style.backgroundColor='#E2B43A'"
              title="View Details"
            >
              <lucide-angular [img]="Eye" class="w-4 h-4" />
            </button>
            <button
              (click)="editUser(user)"
              class="p-2 rounded-md transition-colors"
              style="background-color: #0d5a4b; color: white"
              onmouseover="this.style.backgroundColor='#0f6b5a'"
              onmouseout="this.style.backgroundColor='#0D5A4B'"
              title="Edit"
            >
              <lucide-angular [img]="Pencil" class="w-4 h-4" />
            </button>
            @if (user.isActive) {
            <button
              (click)="deleteUser(user)"
              class="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
              title="Deactivate User"
            >
              <lucide-angular [img]="Trash2" class="w-4 h-4" />
            </button>
            } @else {
            <button
              (click)="deleteUser(user)"
              class="p-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
              title="Activate User"
            >
              <lucide-angular [img]="Check" class="w-4 h-4" />
            </button>
            }
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10" class="text-center py-4">No users found</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Toggle Status Confirmation Dialog -->
  <p-dialog
    [(visible)]="deleteDialogVisible"
    [modal]="true"
    [style]="{ width: '450px' }"
    [header]="selectedUser?.isActive ? 'Deactivate User' : 'Activate User'"
    [draggable]="false"
    [resizable]="false"
  >
    <div class="flex flex-col gap-4">
      <p class="text-gray-700">
        Are you sure you want to
        <span class="font-semibold" style="color: #e2b43a">
          {{ selectedUser?.isActive ? 'deactivate' : 'activate' }}
        </span>
        user
        <span class="font-semibold" style="color: #e2b43a">{{ selectedUser?.userName }}</span
        >?
      </p>
      <p class="text-sm text-gray-500">
        {{
          selectedUser?.isActive
            ? 'The user will be deactivated and unable to access the system.'
            : 'The user will be activated and able to access the system.'
        }}
      </p>
    </div>
    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-2">
        <button
          type="button"
          (click)="cancelDelete()"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="confirmDelete()"
          class="px-4 py-2 rounded-md text-white transition-colors hover:opacity-90"
          [style.background-color]="selectedUser?.isActive ? '#dc2626' : '#16a34a'"
        >
          {{ selectedUser?.isActive ? 'Deactivate' : 'Activate' }}
        </button>
      </div>
    </ng-template>
  </p-dialog>
</div>
